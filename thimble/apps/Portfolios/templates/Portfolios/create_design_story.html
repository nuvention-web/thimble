{%extends 'Portfolios/base_portfolio.html' %}
{%load staticfiles%}
{% load cloudinary %}

{%block cloudinary%}
    {% cloudinary_includes %}
    {% cloudinary_js_config %}

    <script>
        var photos_upload = -1;
        $(function () {
            $('#direct_upload input[type="file"]').fileupload({
                dropZone: '#direct_upload'
            }).on('cloudinarydone', function (e, data) {
                $('.status').show();  
                var x = $(this).attr('data-cloudinary-field');
                $('.status').append(x+' upload complete!\n');
            
                photos_upload++;
                $("#id_num_photos").val(photos_upload);
                if(photos_upload > 0)
                {
                    $("button").attr("disabled",false);
                }
            });
        });
    </script>
    
{% endblock %}

{%block content%}
	<div id="direct_upload" class="row" style="width:50%; margin:2% auto">
        <h2> Write a Design Story</h2>
        {{error}}
		<form method='post' action="{%url 'Portfolios:create_design_story' request.user.username%}">
			{%csrf_token%}
            {% for field in design_story_form %}
                <div class = 'form-group'>
                    <div>{{field.errors|striptags}}</div>
                    {{field.label_tag}}
                    {{field}}
                </div>
            {% endfor %}
            <hr/>
            <h3>Write Your First Chapter</h3>
            {%for field in entry_form.visible_fields%}
                <div class = 'form-group'>
                    <div>{{field.errors|striptags}}</div>
                    {{field.label_tag}}
                    {% if field.label == 'Main Photo' %}
                        <br/>
                        <a href="#" id="cover_upload_widget_opener"></a>
                        <!--TODO Somehow need to make this form item get all that django-generated shit, or circumvent-->
                    {% elif field.label == 'Supplementary Photos'%}
                        <br/>
                        <a href="#" id="supp_upload_widget_opener"></a>
                    {% else %}
                        {{field}}
                    {% endif %}
                </div>
            {%endfor%} 
            {% for hidden in entry_form.hidden_fields %}
                 {{ hidden }}
            {% endfor %}

            <button type='submit' class='btn btn-primary' disabled='true'>Create</button>




            <script src="https://widget.cloudinary.com/global/all.js" type="text/javascript"></script>
             <!--TODO get a local version of this and maybe we can customize more-->

            <script type="text/javascript">
              $('#cover_upload_widget_opener').cloudinary_upload_widget(
                      <!--Can you set the folder, etc. here? take a look at upload preset in Cloudinary settings...-->
                { cloud_name: 'thimbleapp', upload_preset: 'orphans',
                  cropping: 'server', cropping_aspect_ratio:0.5, button_caption:"Upload Cover"},
                function(error, result) { console.log(error, result) });

              $('#supp_upload_widget_opener').cloudinary_upload_widget(
                { cloud_name: 'thimbleapp', upload_preset: 'orphans',
                  cropping: 'server', cropping_aspect_ratio:0.5, button_caption:"Upload Supplementary"},
                function(error, result) { console.log(error, result) });
            </script>

             <!--HENRY NOTE: We should instead have both fields be single-upload (aka one at a time) and have the cover photo always
                overwrite the old ones if they use it multiple times

                Basically instead of the Django-generated image form, we just hook it up to this widget

                Should be very customizable: http://cloudinary.com/documentation/upload_widget

                -->

		</form>
        <div class='status' hidden='true'>
            <h3>Photo Upload Status</h3>
        </div>
	</div>

{%endblock%}